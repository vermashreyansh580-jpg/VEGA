name: VEGA Final Auto-Build
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      # Flutter install kar rahe hain taaki FINAL step mein APK build kar sakein
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Python Dependencies
        run: pip install -r requirements.txt

      - name: üèóÔ∏è Create Project Skeleton
        run: |
          # 1. Pehle ensure karo ki folder exist nahi karta (Clean Start)
          rm -rf build_env
          
          # 2. Flet ko "y" feed karo taaki wo SDK download kar le
          # '--verbose' flag lagaya hai taaki humein sab dikhe
          echo "y" | flet build apk --project build_env --module-name main --verbose
          
          # 3. üî• CRITICAL CHECK: Agar project nahi bana, toh yahi rok do
          if [ ! -f "build_env/pubspec.yaml" ]; then
             echo "‚ùå ERROR: Flet failed to create project structure!"
             echo "üìÇ Content of current directory:"
             ls -R
             exit 1
          fi
          echo "‚úÖ Project Created Successfully!"

      - name: üíâ INJECT ALL PERMISSIONS (XML)
        run: |
          MANIFEST="build_env/android/app/src/main/AndroidManifest.xml"
          
          # XML Inject karo
          cat <<EOF > $MANIFEST
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.example.app">
              
              <uses-permission android:name="android.permission.INTERNET"/>
              <uses-permission android:name="android.permission.RECORD_AUDIO"/>
              <uses-permission android:name="android.permission.CAMERA"/>
              
              <uses-permission android:name="android.permission.SEND_SMS"/>
              <uses-permission android:name="android.permission.READ_SMS"/>
              <uses-permission android:name="android.permission.RECEIVE_SMS"/>
              <uses-permission android:name="android.permission.CALL_PHONE"/>
              <uses-permission android:name="android.permission.READ_CALL_LOG"/>
              
              <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
              <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
              <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"/>
              
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>
              <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>
              
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
              <uses-permission android:name="android.permission.WAKE_LOCK"/>
              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>
              <uses-permission android:name="android.permission.READ_CONTACTS"/>

              <application android:label="VEGA" android:icon="@mipmap/ic_launcher">
                  <activity android:name=".MainActivity" android:exported="true" android:launchMode="singleTop" android:theme="@style/LaunchTheme" android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode" android:hardwareAccelerated="true" android:windowSoftInputMode="adjustResize">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          echo "‚úÖ Permissions Injected."

      - name: üíâ INJECT KOTLIN (Auto-Popup Logic)
        run: |
          KOTLIN_FILE="build_env/android/app/src/main/kotlin/com/example/app/MainActivity.kt"
          mkdir -p $(dirname $KOTLIN_FILE)
          
          cat <<EOF > $KOTLIN_FILE
          package com.example.app
          import io.flutter.embedding.android.FlutterActivity
          import androidx.annotation.NonNull
          import io.flutter.embedding.engine.FlutterEngine
          import android.content.pm.PackageManager
          import android.os.Build
          import androidx.core.app.ActivityCompat
          import androidx.core.content.ContextCompat
          import java.util.ArrayList

          class MainActivity: FlutterActivity() {
              override fun configureFlutterEngine(@NonNull flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                      val perms = arrayOf(
                          android.Manifest.permission.RECORD_AUDIO,
                          android.Manifest.permission.CAMERA,
                          android.Manifest.permission.SEND_SMS,
                          android.Manifest.permission.CALL_PHONE,
                          android.Manifest.permission.READ_CONTACTS,
                          android.Manifest.permission.ACCESS_FINE_LOCATION,
                          android.Manifest.permission.READ_EXTERNAL_STORAGE,
                          android.Manifest.permission.WRITE_EXTERNAL_STORAGE
                      )

                      val reqList = ArrayList<String>()
                      for (p in perms) {
                          if (ContextCompat.checkSelfPermission(this, p) != PackageManager.PERMISSION_GRANTED) {
                              reqList.add(p)
                          }
                      }

                      if (reqList.isNotEmpty()) {
                          ActivityCompat.requestPermissions(this, reqList.toTypedArray(), 101)
                      }
                  }
              }
          }
          EOF
          echo "‚úÖ Kotlin Logic Injected."

      - name: üöÄ Build APK (Using System Flutter)
        run: |
          cd build_env
          flutter pub get
          flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: VEGA-GOD-APK
          path: build_env/build/app/outputs/flutter-apk/app-release.apk
